å‚è€ƒç½‘å€ï¼šhttps://github.com/apple/swift/blob/master/docs/OptimizationTips.rst

å¯åŠ¨ä¼˜åŒ–ï¼š
é€šå¸¸ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯å¯åŠ¨ä¼˜åŒ–ã€‚Swiftæä¾›äº†ä¸‰ç§ä¸åŒçš„ä¼˜åŒ–çº§åˆ«ï¼š

â˜€ -Onone: è¿™ä¸ªæ„å‘³ç€æ­£å¸¸çš„å¼€å‘ã€‚è¿™ä¸ªçº§åˆ«æ‰§è¡Œæœ€å°çš„ä¼˜åŒ–å’Œä¿å­˜æ‰€æœ‰çš„debugä¿¡æ¯ã€‚
â˜€ï¸ -O:è¿™ä¸ªæ„å‘³ç€å¯¹äºå¤§å¤šæ•°ç”Ÿäº§ä»£ç ã€‚ç¼–è¯‘å™¨ç§¯æçš„è¿›è¡Œä¼˜åŒ–ï¼Œå¤§å¤§æ”¹å–„æäº¤ä»£ç çš„ç±»å‹å’Œæ•°é‡ã€‚debugä¿¡æ¯ä¼šè¢«æäº¤ä½†æ˜¯ä¼šæœ‰æ‰€çœç•¥ã€‚   
â˜€ -Ounchecked: è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¼˜åŒ–æ¨¡å¼ï¼Œå¯¹äºä¸€äº›ç‰¹å®šçš„åº“æˆ–è€…æ˜¯åº”ç”¨æ˜¯ç”¨å®‰å…¨æ€§æ¥æ¢å–æ€§èƒ½ã€‚ç¼–è¯‘å™¨ä¼šç§»é™¤æ‰€æœ‰çš„æº¢å‡ºæ£€æµ‹å’Œä¸€äº›éšå¼çš„ç±»å‹æ£€æŸ¥ã€‚
è¿™ä¸æ˜¯åœ¨é€šå¸¸æƒ…å†µä¸‹ä½¿ç”¨çš„ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå¯¼è‡´å†…å­˜å®‰å…¨é—®é¢˜å’Œæ•´æ•°æº¢å‡ºã€‚å¦‚æœä½ æƒ³è¿™æ ·åšçš„è¯ï¼Œå¿…é¡»ä»”ç»†å®¡æŸ¥ä½ çš„ä»£ç å¯¹æ•´æ•°æº¢å‡ºå’Œç±»å‹è½¬æ¢æ¥è¯´æ˜¯å®‰å…¨çš„ã€‚

æ•´ä½“ç»„ä»¶ä¼˜åŒ–ï¼š
é»˜è®¤æƒ…å†µä¸‹ï¼ŒSwiftå•ç‹¬ç¼–è¯‘æ¯ä¸ªæ–‡ä»¶ã€‚è¿™èƒ½è®©Xcodeéå¸¸å¿«é€Ÿçš„å¹¶è¡Œç¼–è¯‘å¤šä¸ªæ–‡ä»¶ã€‚ç„¶è€Œï¼Œæ¯ä¸ªæ–‡ä»¶å•ç‹¬ç¼–è¯‘çš„è¯ä¼šé˜»æ­¢æŸäº›ç¼–è¯‘å™¨çš„ä¼˜åŒ–ã€‚
Swiftåœ¨å³ä½¿å®ƒæ˜¯ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶æˆ–æ˜¯ä¸€ä¸ªå•ç‹¬çš„å•å…ƒä¹Ÿèƒ½å¤Ÿå¯¹è¿™ä¸ªç¨‹åºè¿›è¡Œç¼–è¯‘ã€‚
è¿™ä¸ªæ¨¡å¼å¯ä»¥æ˜¯ç”¨å‘½ä»¤è¡Œflag -whole-module-optimizationæ¥å¼€å¯ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹è¢«ç¼–è¯‘çš„ç¨‹åºæœ€æœ‰å¯èƒ½éœ€è¦æ›´é•¿çš„æ—¶é—´æ¥ç¼–è¯‘ï¼Œä½†æ˜¯è¿è¡Œèµ·æ¥ä¼šæ›´å¿«ã€‚

è¿™ä¸ªæ¨¡å¼èƒ½å¤Ÿé€šè¿‡Xcodeä¸­çš„build setting â€˜Whole Module Optimizationâ€™æ¥å¯ç”¨ã€‚

å‡å°‘åŠ¨æ€è°ƒåº¦
Swiftåœ¨é»˜è®¤æƒ…å†µä¸‹å°±åƒOCé‚£æ ·æ˜¯éå¸¸åŠ¨æ€è¯­è¨€ã€‚ä¸OCä¸åŒçš„æ˜¯ï¼ŒSwiftèƒ½å¤Ÿè®©ç¨‹åºå‘˜åœ¨å¿…è¦æ—¶å€™æœ‰èƒ½åŠ›å»ç§»é™¤æˆ–å‡å°‘è¿™ç§åŠ¨æ€æœºåˆ¶ä»è€Œæå‡è¿è¡Œæ—¶çš„æ€§èƒ½ã€‚
ä»¥ä¸‹æ˜¯å‡ ä¸ªç¤ºä¾‹ï¼š

åŠ¨æ€è°ƒåº¦
é»˜è®¤æƒ…å†µä¸‹ç±»ä½¿ç”¨åŠ¨æ€è°ƒåº¦æ–¹æ³•å’Œå±æ€§ã€‚å› æ­¤ä¸‹é¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œa.aProperty,a.doSomething,a.doSomethingElseæ–¹æ³•éƒ½æ˜¯é€šè¿‡åŠ¨æ€è°ƒåº¦æ¥è°ƒç”¨çš„ã€‚
class A {
  var aProperty: [Int]
  func doSomething() { ... }
  dynamic doSomethingElse() { ... }
}

class B : A {
  override var aProperty {
    get { ... }
    set { ... }
  }

  override func doSomething() { ... }
}

func usingAnA(a: A) {
  a.doSomething()
  a.aProperty = ...
}

åœ¨Swiftä¸­ï¼ŒåŠ¨æ€è°ƒåº¦é»˜è®¤æƒ…å†µä¸‹æ˜¯é€šè¿‡ä¸€ä¸ªvtableï¼ˆè™šå‡½æ•°è¡¨ï¼‰é—´æ¥çš„è°ƒç”¨ã€‚å¦‚æœä½¿ç”¨äº†dynamicå…³é”®å­—æ¥å£°æ˜ï¼ŒSwiftä¼šè°ƒç”¨OCå‘é€æ¶ˆæ¯çš„æ–¹æ³•å»æ›¿ä»£ã€‚
è¿™ä¸¤ç§æƒ…å†µéƒ½è¦æ¯”ç›´æ¥çš„æ–¹æ³•è°ƒç”¨æ…¢ï¼Œå› ä¸ºè¿™æ ·å°±ä¼šé˜»æ­¢é™¤é—´æ¥è°ƒç”¨æœ¬èº«ä¹‹å¤–çš„è®¸å¤šç¼–è¯‘å™¨çš„ä¼˜åŒ–ã€‚åœ¨æ€§èƒ½å…³é”®çš„ä»£ç ä¸­ï¼ŒåŠ¨æ€è¡Œä¸ºä¼šè¢«ä¸¥æ ¼çš„é™åˆ¶ã€‚

å»ºè®®ï¼šå½“ä½ çŸ¥é“å£°æ˜ä»¥åä¸ä¼šè¢«é‡å†™ï¼ˆoverriddenï¼‰çš„æ—¶å€™ï¼Œè¯·ä½¿ç”¨'final'å…³é”®å­—ã€‚

finalå…³é”®å­—æ˜¯å£°æ˜ç±»ï¼Œæ–¹æ³•æˆ–è€…å±æ€§ä¸Šçš„ä¸€ä¸ªé™åˆ¶ï¼Œè¿™æ ·å£°æ˜å°±ä¸èƒ½è¢«é‡å†™ï¼ˆoverriddenï¼‰ã€‚è¿™å°±æ„å‘³ç€ç¼–è¯‘å™¨èƒ½å¤Ÿç›´æ¥çš„è°ƒç”¨æ–¹æ³•è€Œä¸æ˜¯é—´æ¥çš„è°ƒç”¨ã€‚
ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼ŒC.array1,D.array1ä¼šç›´æ¥çš„è¯»å–ï¼Œè€ŒD.array2åˆ™å°±é—´æ¥çš„é€šè¿‡vtableæ¥è°ƒç”¨ã€‚
final class C {
  // No declarations in class 'C' can be overridden.
  var array1: [Int]
  func doSomething() { ... }
}

class D {
  final var array1 [Int] // 'array1' cannot be overridden by a computed property.
  var array2: [Int]      // 'array2' *can* be overridden by a computed property.
}

func usingC(c: C) {
   c.array1[i] = ... // Can directly access C.array without going through dynamic dispatch.
   c.doSomething() = ... // Can directly call C.doSomething without going through virtual dispatch.
}

func usingD(d: D) {
   d.array1[i] = ... // Can directly access D.array1 without going through dynamic dispatch.
   d.array2[i] = ... // Will access D.array2 through dynamic dispatch.
}

å»ºè®®ï¼šå½“å£°æ˜æ—¶ä¸éœ€è¦è¢«å¤–éƒ¨æ–‡ä»¶è®¿é—®ï¼Œè¯·ä½¿ç”¨å…³é”®å­—â€˜privateâ€™

ä½¿ç”¨privateå…³é”®å­—è¿›è¡Œå£°æ˜ï¼Œé™åˆ¶äº†å£°æ˜æ–‡ä»¶çš„å¯è§æ€§ã€‚
è¿™ä¸ªèƒ½è®©ç¼–è¯‘å™¨æœ‰èƒ½åŠ›ç”„åˆ«å‡ºæ‰€æœ‰å…¶å®ƒæ½œåœ¨çš„è¦†ç›–å£°æ˜ã€‚å› æ­¤ï¼Œç”±äºä»¥ä¸Šçš„å£°æ˜èƒ½è®©ç¼–è¯‘å™¨è‡ªåŠ¨åœ°æ¨æ–­å‡ºfianlå…³é”®å­—ï¼Œ
å¹¶ä¸”ç§»é™¤é—´æ¥æ–¹æ³•è°ƒç”¨å’Œå±æ€§è®¿é—®ã€‚
ä»¥ä¸‹ç¤ºä¾‹ï¼Œe.doSomething()å’Œf.myPrivateVarï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªæ–‡ä»¶ç±»E,Fä¸­æ²¡æœ‰ä»»ä½•è¦†ç›–å£°æ˜ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å°†è¢«ç›´æ¥è°ƒç”¨ã€‚
private class E {
  func doSomething() { ... }
}

class F {
  private var myPrivateVar : Int
}

func usingE(e: E) {
  e.doSomething() // There is no sub class in the file that declares this class.
                  // The compiler can remove virtual calls to doSomething()
                  // and directly call A's doSomething method.
}

func usingF(f: F) -> Int {
  return f.myPrivateVar
}

é«˜æ•ˆä½¿ç”¨å®¹å™¨ç±»
ç”±Swiftæ ‡å‡†ç±»åº“æä¾›ä¸€ä¸ªé‡è¦ç‰¹æ€§å°±æ˜¯é€šç”¨å®¹å™¨ï¼ŒArrayå’ŒDictionaryã€‚ä¸‹é¢å†…å®¹å°†è§£é‡Šå¦‚ä½•é«˜æ•ˆçš„ä½¿ç”¨è¿™äº›ç±»å‹ã€‚

å»ºè®®ï¼šåœ¨Arrayä¸­ä½¿ç”¨å€¼ç±»å‹
åœ¨Swiftä¸­ï¼Œç±»å‹èƒ½è¢«åˆ†ä¸ºä¸¤ç±»ï¼šå€¼ç±»å‹ï¼ˆåƒç»“æ„ä½“ï¼Œæšä¸¾ï¼Œå…ƒç»„ï¼‰å’Œå¼•ç”¨ç±»å‹ï¼ˆç±»ï¼‰ã€‚ä¸€ä¸ªå…³é”®çš„åŒºåˆ«æ˜¯åœ¨NSArrayä¸­ä¸èƒ½åŒ…å«å€¼ç±»å‹ã€‚
å› æ­¤ï¼Œå½“ä½¿ç”¨å€¼ç±»å‹æ—¶ï¼Œåœ¨Arrayä¸­ï¼Œä¼˜åŒ–å™¨ä¼šç§»é™¤å¤§éƒ¨åˆ†å¯¹NSArrayçš„æ”¯æŒä»é™ä½å…¶ä¸­é¢å¤–çš„å¼€é”€ã€‚
æ­¤å¤–ï¼Œç›¸æ¯”å¼•ç”¨ç±»å‹ï¼Œå¦‚æœå€¼ç±»å‹ä»…ä»…é€’å½’çš„åŒ…å«å¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆå€¼ç±»å‹ä»…ä»…éœ€è¦å¼•ç”¨è®¡æ•°å™¨ã€‚
å¦‚æœä½¿ç”¨äº†æ²¡æœ‰å¼•ç”¨ç±»å‹çš„å€¼ç±»å‹ï¼Œåœ¨æ•°ç»„å†…å°±å¯ä»¥é¿å…é¢å¤–çš„retainï¼Œreleaseçš„å¼€é”€ã€‚
// Don't use a class here.
struct PhonebookEntry {
  var name : String
  var number : [Int]
}

var a : [PhonebookEntry]

è®°ä½ï¼šåœ¨å¤§å€¼ç±»å‹å’Œä½¿ç”¨å¼•ç”¨ç±»å‹ä¹‹é—´è¦ç”±æƒè¡¡ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‹·è´å’Œç§»åŠ¨å¤§å€¼ç±»å‹è¿‡çš„æ¶ˆè€—è¦å¤§äºç§»é™¤brigdingå’Œretain/releaseçš„å¼€é”€ã€‚

å»ºè®®ï¼šå½“NSArray bridgingä¸å¿…è¦æ—¶ï¼Œä½¿ç”¨ContiguousArrayæ¥å­˜å‚¨å¼•ç”¨ç±»å‹ã€‚
å¦‚æœä½ éœ€è¦ä¸ªå¼•ç”¨ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„ä¸éœ€è¦bridgeåˆ°NSArrayï¼Œä½¿ç”¨ContiguousArrayä»£æ›¿Array:
class C { ... }
var a: ContiguousArray<C> = [C(...), C(...), ..., C(...)]

å»ºè®®ï¼šä½¿ç”¨é€‚å½“çš„å¯å˜ä»£æ›¿å¯¹è±¡åˆ†é…ã€‚
åœ¨Swiftçš„æ‰€æœ‰æ ‡å‡†åº“å®¹å™¨æ˜¯å€¼ç±»å‹ï¼Œä½¿ç”¨COW(copy-on-write)æ‰§è¡Œæ‹·è´æ›¿ä»£äº†æ˜¾ç¤ºæ‹·è´ã€‚
å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨çœç•¥äº†ä¸å¿…è¦çš„æ‹·è´é€šè¿‡æŒæœ‰å®¹å™¨è€Œä¸æ˜¯æ·±æ‹·è´ã€‚
åªæœ‰å½“å®¹å™¨çš„å¼•ç”¨è®¡æ•°å¤§äº1æ–Œåˆ‡è¯¥å®¹å™¨æ˜¯å¯å˜çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ‹·è´åº•å±‚å®¹å™¨ã€‚
ä¸‹é¢ç¤ºä¾‹ä¸­ï¼Œå½“dèµ‹å€¼ç»™cçš„æ—¶å€™ä¸ä¼šå‘ç”Ÿæ‹·è´ï¼Œä½†æ˜¯å½“dç»å†äº†ç»“æ„æ€§çš„æ”¹å˜è¿½åŠ 2æ—¶ï¼Œdå°†ä¼šè¢«æ‹·è´å¹¶ä¸”2ä¹Ÿä¼šè¢«è¿½åŠ åˆ°dä¸­ã€‚
var c: [Int] = [ ... ]
var d = c        // No copy will occur here.
d.append(2)      // A copy *does* occur here.

æœ‰æ—¶å€™å¦‚æœä½¿ç”¨è€…ä¸å°å¿ƒï¼ŒCOWä¹Ÿä¼šå¼•èµ·é¢å¤–çš„æ‹·è´ã€‚ä¾‹å¦‚ï¼Œåœ¨å‡½æ•°ä¸­è¯•å›¾ä¿®æ”¹å¯å˜å‚æ•°å¯¹è±¡ï¼Œåœ¨Swiftä¸­ï¼Œæ‰€æœ‰çš„å‚æ•°éƒ½ä¼šåœ¨è°ƒç”¨ä¹‹å‰å¼•ç”¨ï¼‹1ï¼Œ
ç„¶ååœ¨è°ƒç”¨ç»“æŸä¹‹å‰é‡Šæ”¾æ‰ã€‚è¿™æ„å‘³ç€å¦‚ä¸‹æ–¹æ³•æ‰€ç¤ºï¼š
func append_one(a: [Int]) -> [Int] {
  a.append(1)
  return a
}

var a = [1, 2, 3]
a = append_one(a)    // A copy may be occur here.

å°½ç®¡aç‰ˆæœ¬åœ¨è¢«append_oneä¹‹åí ½ç”±äºèµ‹å€¼æ²¡ä½¿ç”¨æœ‰ï¼Œä½†æ˜¯  aä¹Ÿè®¸è¿˜æ˜¯è¢«æ‹·è´äº†ã€‚åº”è¯¥ä½¿ç”¨inoutå‚æ•°æ¥é¿å…è¿™æ ·çš„é—®é¢˜ã€‚
func append_one_in_place(inout a: [Int]) {
  a.append(1)
}

var a = [1, 2, 3]
append_one_in_place(&a)










